# Daily Note æ€»ç»“åŠŸèƒ½å¢å¼ºå®æ–½è®¡åˆ’

## ä¸€ã€é—®é¢˜åˆ†æä¸ç›®æ ‡å®šä¹‰

### 1.1 å½“å‰å­˜åœ¨çš„é—®é¢˜

é€šè¿‡åˆ†æç°æœ‰ä»£ç ï¼Œæˆ‘å‘ç°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

1. **æ€»ç»“ç»“æœä¸æŒä¹…**
   - å½“å‰æ€»ç»“ç»“æœå­˜å‚¨åœ¨ `ClaudeTask.result` å­—æ®µï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
   - è™½ç„¶ä»£ç ä¸­æœ‰ `saveSummaryAsNote` æ–¹æ³•ï¼Œä½†å®é™…åˆ›å»ºçš„ç¬”è®°åªåŒ…å«æ ¼å¼åŒ–çš„ Markdown å†…å®¹
   - æ€»ç»“çš„ç»“æ„åŒ–æ•°æ®ï¼ˆç»Ÿè®¡åˆ†æã€AI æ´å¯Ÿç­‰ï¼‰å­˜å‚¨åœ¨ä»»åŠ¡è¡¨ä¸­ï¼Œå®¹æ˜“è¢«æ¸…ç†

2. **ç¼ºå°‘çŸ¥è¯†æç‚¼**
   - ç°æœ‰ AI æç¤ºè¯ä¸»è¦å…³æ³¨æ•°æ®ç»Ÿè®¡å’Œè¡¨é¢æ€»ç»“
   - ç¼ºå°‘æ·±å±‚æ¬¡çš„çŸ¥è¯†æç‚¼ã€å­¦ä¹ æ”¶è·æå–
   - æ²¡æœ‰è¶‹åŠ¿åˆ†æå’Œæ¨¡å¼è¯†åˆ«

3. **å®ä½“è¯†åˆ«ç¼ºå¤±**
   - NoteRelation è¡¨å­˜åœ¨ä½†æœªå……åˆ†åˆ©ç”¨
   - æ²¡æœ‰å®ä½“è¯†åˆ«åŠŸèƒ½ï¼ˆäººåã€æŠ€æœ¯åè¯ã€æ¦‚å¿µç­‰ï¼‰
   - æ— æ³•æ„å»ºçŸ¥è¯†ç½‘ç»œ

4. **è‡ªåŠ¨å…³è”ä¸è¶³**
   - å½“å‰ä»£ç ä¸­æ²¡æœ‰è‡ªåŠ¨ç¬”è®°å…³è”çš„å®ç°
   - NoteRelation è¡¨ä»…ä½œä¸ºæ•°æ®æ¨¡å‹å­˜åœ¨ï¼Œæ²¡æœ‰å¡«å……é€»è¾‘

5. **å†å²ç®¡ç†ç¼ºå¤±**
   - æ— æ³•æŸ¥çœ‹å’Œå¯¹æ¯”å†å²æ€»ç»“
   - ç¼ºå°‘æ€»ç»“ç‰ˆæœ¬ç®¡ç†

### 1.2 æ ¸å¿ƒç›®æ ‡

åŸºäºç”¨æˆ·çš„åœºæ™¯ï¼š"ç¢ç‰‡åŒ–è®°å½• â†’ AIè‡ªåŠ¨æ•´ç†/å…³è” â†’ å®šæœŸæ€»ç»“ â†’ çŸ¥è¯†ç½‘ç»œ"ï¼Œæˆ‘ä»¬è®¾å®šä»¥ä¸‹ç›®æ ‡ï¼š

1. **æŒä¹…åŒ–å­˜å‚¨**ï¼šå°†æ€»ç»“çš„ç»“æ„åŒ–æ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œæ”¯æŒå†å²æŸ¥è¯¢
2. **çŸ¥è¯†æç‚¼**ï¼šä»ç¬”è®°ä¸­æå–å…³é”®æ´å¯Ÿã€å­¦ä¹ æ”¶è·ã€è¶‹åŠ¿æ¨¡å¼
3. **å®ä½“è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«äººåã€æŠ€æœ¯åè¯ã€æ¦‚å¿µç­‰å®ä½“
4. **æ™ºèƒ½å…³è”**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦å’Œå®ä½“å…³è”è‡ªåŠ¨å»ºç«‹ç¬”è®°å…³ç³»
5. **å†å²ç®¡ç†**ï¼šæ”¯æŒæ€»ç»“å†å²æŸ¥è¯¢ã€å¯¹æ¯”ã€ç‰ˆæœ¬ç®¡ç†

---

## äºŒã€æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 æ–°å¢/ä¿®æ”¹çš„è¡¨ç»“æ„

#### 2.1.1 Summary è¡¨ï¼ˆæ–°å¢ï¼‰

ç”¨äºæŒä¹…åŒ–å­˜å‚¨æ€»ç»“çš„ç»“æ„åŒ–æ•°æ®ï¼š

```prisma
// æ€»ç»“è®°å½•ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰
model Summary {
  id          String   @id @default(uuid())
  mode        String   // 'day' | 'week' | 'month' | 'year' | 'custom'
  startDate   DateTime
  endDate     DateTime

  // æ€»ç»“å†…å®¹
  overview    String   // AI ç”Ÿæˆçš„æ¦‚è¿°
  achievements String   // JSON æ•°ç»„ï¼šå…³é”®æˆå°±
  pendingTasks String   // JSON æ•°ç»„ï¼šå¾…åŠä»»åŠ¡
  insights    String   // JSON æ•°ç»„ï¼šæ„Ÿæ‚Ÿæ´å¯Ÿ

  // çŸ¥è¯†æç‚¼ï¼ˆæ–°å¢ï¼‰
  keyLearnings String?  // JSON æ•°ç»„ï¼šå…³é”®å­¦ä¹ ç‚¹
  trends      String?   // JSON æ•°ç»„ï¼šè¶‹åŠ¿åˆ†æ
  patterns    String?   // JSON æ•°ç»„ï¼šå‘ç°çš„æ¨¡å¼
  recommendations String? // JSON æ•°ç»„ï¼šåŸºäºæ´å¯Ÿçš„å»ºè®®

  // ç»Ÿè®¡æ•°æ®ï¼ˆç»“æ„åŒ–å­˜å‚¨ï¼‰
  noteCount   Int
  sentimentData String  // JSONï¼šå¿ƒæƒ…æ›²çº¿æ•°æ®
  categoryStats String  // JSONï¼šåˆ†ç±»ç»Ÿè®¡
  tagStats    String   // JSONï¼šæ ‡ç­¾ç»Ÿè®¡
  importanceStats String // JSONï¼šé‡è¦æ€§ç»Ÿè®¡
  taskStats   String   // JSONï¼šä»»åŠ¡å®Œæˆç»Ÿè®¡
  timeStats   String   // JSONï¼šæ—¶é—´åˆ†å¸ƒç»Ÿè®¡

  // å…ƒæ•°æ®
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  taskId      String   @unique // å…³è”çš„ ClaudeTask ID
  isAutoGenerated Boolean @default(true)

  @@index([mode, startDate])
  @@index([generatedAt])
}
```

#### 2.1.2 Entity è¡¨ï¼ˆæ–°å¢ï¼‰

ç”¨äºå­˜å‚¨è¯†åˆ«çš„å®ä½“ï¼š

```prisma
// å®ä½“ï¼ˆäººåã€æŠ€æœ¯åè¯ã€æ¦‚å¿µç­‰ï¼‰
model Entity {
  id          String   @id @default(uuid())
  name        String   @unique
  type        String   // 'person' | 'technology' | 'concept' | 'organization' | 'location' | 'other'
  description String?  // å®ä½“æè¿°
  aliases     String?  // JSON æ•°ç»„ï¼šåˆ«å/åŒä¹‰è¯

  // ç»Ÿè®¡ä¿¡æ¯
  mentionCount Int     @default(0)
  firstMentionedAt DateTime?
  lastMentionedAt DateTime?

  // å…³è”
  mentions    EntityMention[]
  relations   EntityRelation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([mentionCount])
}
```

#### 2.1.3 EntityMention è¡¨ï¼ˆæ–°å¢ï¼‰

ç”¨äºè®°å½•å®ä½“åœ¨ç¬”è®°ä¸­çš„æåŠï¼š

```prisma
// å®ä½“æåŠè®°å½•
model EntityMention {
  id          String   @id @default(uuid())
  entityId    String
  noteId      String
  context     String   // æåŠçš„ä¸Šä¸‹æ–‡ç‰‡æ®µ
  sentiment   String?  // 'positive' | 'neutral' | 'negative'
  importance  Int      @default(5) // æåŠçš„é‡è¦æ€§

  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)
  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([entityId, noteId])
  @@index([entityId])
  @@index([noteId])
}
```

#### 2.1.4 EntityRelation è¡¨ï¼ˆæ–°å¢ï¼‰

ç”¨äºå»ºç«‹å®ä½“ä¹‹é—´çš„å…³ç³»ï¼š

```prisma
// å®ä½“å…³ç³»
model EntityRelation {
  id          String   @id @default(uuid())
  fromEntityId String
  toEntityId   String
  relationType String // 'related' | 'part_of' | 'uses' | 'mentions' | 'similar'
  strength    Float   @default(1.0) // å…³ç³»å¼ºåº¦ 0-1
  context     String? // å…³ç³»ä¸Šä¸‹æ–‡

  fromEntity  Entity   @relation("FromEntity", fields: [fromEntityId], references: [id], onDelete: Cascade)
  toEntity    Entity   @relation("ToEntity", fields: [toEntityId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([fromEntityId, toEntityId, relationType])
  @@index([fromEntityId])
  @@index([toEntityId])
}
```

#### 2.1.5 NoteRelation è¡¨å¢å¼ºï¼ˆä¿®æ”¹ï¼‰

ç°æœ‰è¡¨éœ€è¦å¢åŠ å­—æ®µï¼š

```prisma
// ç¬”è®°å…³è”ï¼ˆå¢å¼ºç‰ˆï¼‰
model NoteRelation {
  id         String   @id @default(uuid())
  fromId     String
  toId       String
  similarity Float?
  reason     String?
  relationType String @default('related') // 'related' | 'follows' | 'conflicts' | 'extends'
  createdAt  DateTime @default(now())

  from Note @relation("FromNote", fields: [fromId], references: [id], onDelete: Cascade)
  to   Note @relation("ToNote", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
  @@index([relationType])
}
```

---

## ä¸‰ã€å…±äº«ç±»å‹å®šä¹‰ï¼ˆshared/types/index.tsï¼‰

```typescript
// ===== æ€»ç»“å¢å¼ºç›¸å…³ç±»å‹ =====

export interface Summary {
  id: string
  mode: 'day' | 'week' | 'month' | 'year' | 'custom'
  startDate: Date
  endDate: Date

  // æ€»ç»“å†…å®¹
  overview: string
  achievements: string[]
  pendingTasks: string[]
  insights: string[]

  // çŸ¥è¯†æç‚¼
  keyLearnings?: string[]
  trends?: string[]
  patterns?: string[]
  recommendations?: string[]

  // ç»Ÿè®¡æ•°æ®
  noteCount: number
  sentimentData: SentimentCurve
  categoryStats: CategoryDistribution[]
  tagStats: TagStats[]
  importanceStats: ImportanceDistribution
  taskStats: TaskCompletion
  timeStats: TimeDistribution

  // å…ƒæ•°æ®
  generatedAt: Date
  updatedAt: Date
  taskId: string
  isAutoGenerated: boolean
}

export interface UpsertSummaryRequest {
  mode: string
  startDate: string
  endDate: string
  overview: string
  achievements: string[]
  pendingTasks: string[]
  insights: string[]
  keyLearnings?: string[]
  trends?: string[]
  patterns?: string[]
  recommendations?: string[]
}

export interface Entity {
  id: string
  name: string
  type: 'person' | 'technology' | 'concept' | 'organization' | 'location' | 'other'
  description?: string
  aliases?: string[]
  mentionCount: number
  firstMentionedAt?: Date
  lastMentionedAt?: Date
  createdAt: Date
  updatedAt: Date
}

export interface EntityMention {
  id: string
  entityId: string
  noteId: string
  context: string
  sentiment?: 'positive' | 'neutral' | 'negative'
  importance: number
  createdAt: Date
}

export interface EntityRelation {
  id: string
  fromEntityId: string
  toEntityId: string
  relationType: 'related' | 'part_of' | 'uses' | 'mentions' | 'similar'
  strength: number
  context?: string
  createdAt: Date
}

export interface SummaryComparison {
  base: Summary
  compare: Summary
  differences: {
    noteCountChange: number
    newAchievements: string[]
    completedTasks: string[]
    newInsights: string[]
    sentimentChange: string
  }
}
```

---

## å››ã€å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šæ•°æ®æŒä¹…åŒ–å’Œå†å²ç®¡ç†ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ç›®æ ‡**ï¼šè§£å†³æ€»ç»“ç»“æœä¸æŒä¹…çš„é—®é¢˜ï¼Œå»ºç«‹æ€»ç»“å†å²ç®¡ç†

**å®æ–½å†…å®¹**ï¼š

1. **æ•°æ®æ¨¡å‹å˜æ›´**
   - åˆ›å»º `Summary` è¡¨
   - ä¿®æ”¹æ•°æ®åº“è¿ç§»è„šæœ¬

2. **åç«¯å®ç°**
   - åˆ›å»º `backend/src/services/summary-persistence.service.ts`
   - ä¿®æ”¹ `summary-analyzer.executor.ts`ï¼Œåœ¨ä»»åŠ¡å®ŒæˆåæŒä¹…åŒ–åˆ° Summary è¡¨
   - æ‰©å±• `summaries.ts` è·¯ç”±ï¼Œæ·»åŠ å†å²æŸ¥è¯¢ã€å¯¹æ¯”æ¥å£

3. **å‰ç«¯å®ç°**
   - åˆ›å»º `frontend/src/components/SummaryHistory.tsx` - æ€»ç»“å†å²åˆ—è¡¨
   - åˆ›å»º `frontend/src/components/SummaryComparison.tsx` - æ€»ç»“å¯¹æ¯”ç•Œé¢
   - ä¿®æ”¹ `SummaryResultSheet.tsx`ï¼Œæ·»åŠ "æŸ¥çœ‹å†å²"æŒ‰é’®

**å…³é”®ä»£ç ç¤ºä¾‹**ï¼š

```typescript
// summary-persistence.service.ts
export class SummaryPersistenceService {
  async saveSummary(
    result: SummaryAnalysisResult,
    taskId: string,
    mode: string,
    timeRange: { startDate: string; endDate: string }
  ): Promise<Summary> {
    const existing = await prisma.summary.findUnique({
      where: { taskId },
    })

    const data = {
      mode,
      startDate: new Date(timeRange.startDate),
      endDate: new Date(timeRange.endDate),
      overview: result.summary.overview,
      achievements: JSON.stringify(result.summary.keyAchievements),
      pendingTasks: JSON.stringify(result.summary.pendingTasks),
      insights: JSON.stringify(result.summary.insights),
      noteCount: result.period.noteCount,
      sentimentData: JSON.stringify(result.sentimentCurve),
      categoryStats: JSON.stringify(result.noteStatistics.categoryDistribution),
      tagStats: JSON.stringify(result.noteStatistics.topTags),
      importanceStats: JSON.stringify(result.noteStatistics.importanceDistribution),
      taskStats: JSON.stringify(result.taskCompletion),
      timeStats: JSON.stringify(result.timeDistribution),
      taskId,
    }

    if (existing) {
      return await prisma.summary.update({
        where: { id: existing.id },
        data,
      })
    }

    return await prisma.summary.create({ data })
  }

  async getHistory(filters: {
    mode?: string
    year?: number
    month?: number
    limit?: number
  }): Promise<Summary[]> {
    const where: any = {}
    if (filters.mode) where.mode = filters.mode
    if (filters.year || filters.month) {
      where.startDate = {}
      if (filters.year) {
        where.startDate.gte = new Date(filters.year, 0, 1)
        where.startDate.lte = new Date(filters.year, 11, 31)
      }
      if (filters.month) {
        where.startDate.gte = new Date(filters.year || new Date().getFullYear(), filters.month - 1, 1)
        where.startDate.lte = new Date(filters.year || new Date().getFullYear(), filters.month, 0)
      }
    }

    return await prisma.summary.findMany({
      where,
      orderBy: { startDate: 'desc' },
      take: filters.limit || 20,
    })
  }

  async compare(summaryId1: string, summaryId2: string): Promise<SummaryComparison> {
    const [s1, s2] = await Promise.all([
      prisma.summary.findUnique({ where: { id: summaryId1 } }),
      prisma.summary.findUnique({ where: { id: summaryId2 } }),
    ])

    if (!s1 || !s2) throw new Error('Summary not found')

    const achievements1 = JSON.parse(s1.achievements)
    const achievements2 = JSON.parse(s2.achievements)
    const tasks1 = JSON.parse(s1.pendingTasks)
    const tasks2 = JSON.parse(s2.pendingTasks)
    const insights1 = JSON.parse(s1.insights)
    const insights2 = JSON.parse(s2.insights)

    return {
      base: s1 as Summary,
      compare: s2 as Summary,
      differences: {
        noteCountChange: s2.noteCount - s1.noteCount,
        newAchievements: achievements2.filter((a: string) => !achievements1.includes(a)),
        completedTasks: tasks1.filter((t: string) => !tasks2.includes(t)),
        newInsights: insights2.filter((i: string) => !insights1.includes(i)),
        sentimentChange: compareSentiment(s1, s2),
      },
    }
  }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ€»ç»“å®Œæˆåè‡ªåŠ¨ä¿å­˜åˆ° Summary è¡¨
- âœ… å¯ä»¥æŸ¥çœ‹å†å²æ€»ç»“åˆ—è¡¨
- âœ… å¯ä»¥å¯¹æ¯”ä¸¤ä¸ªæ€»ç»“çš„å·®å¼‚
- âœ… åˆ·æ–°é¡µé¢åæ€»ç»“ä¸ä¼šä¸¢å¤±

---

### é˜¶æ®µ2ï¼šå®ä½“è¯†åˆ«å’Œè‡ªåŠ¨å…³è”ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ç›®æ ‡**ï¼šå®ç°å®ä½“è¯†åˆ«ï¼Œæ„å»ºçŸ¥è¯†ç½‘ç»œåŸºç¡€

**å®æ–½å†…å®¹**ï¼š

1. **æ•°æ®æ¨¡å‹å˜æ›´**
   - åˆ›å»º `Entity` è¡¨
   - åˆ›å»º `EntityMention` è¡¨
   - åˆ›å»º `EntityRelation` è¡¨
   - å¢å¼º `NoteRelation` è¡¨

2. **åç«¯å®ç°**
   - åˆ›å»º `backend/src/services/entity.service.ts`
   - åˆ›å»º `backend/src/services/relation.service.ts`
   - åˆ›å»º `backend/src/queue/executors/entity-extractor.executor.ts`
   - æ–°å¢ `entities.ts` å’Œ `relations.ts` è·¯ç”±

3. **å‰ç«¯å®ç°**
   - åˆ›å»º `frontend/src/components/EntityList.tsx`
   - åˆ›å»º `frontend/src/components/EntityDetailSheet.tsx`
   - åˆ›å»º `frontend/src/components/KnowledgeGraph.tsx`
   - åˆ›å»º `frontend/src/components/RelationSuggestions.tsx`

**å…³é”®ä»£ç ç¤ºä¾‹**ï¼š

```typescript
// entity.service.ts
export class EntityService {
  async extractEntities(noteId: string): Promise<void> {
    const note = await prisma.note.findUnique({
      where: { id: noteId },
      include: { noteTags: { include: { tag: true } } },
    })

    if (!note) return

    // è°ƒç”¨ Claude API æå–å®ä½“
    const result = await claudeService.extractEntities(note.content)

    // å¤„ç†æå–çš„å®ä½“
    for (const entityData of result.entities) {
      // æŸ¥æ‰¾æˆ–åˆ›å»ºå®ä½“
      let entity = await prisma.entity.findUnique({
        where: { name: entityData.name },
      })

      if (!entity) {
        entity = await prisma.entity.create({
          data: {
            name: entityData.name,
            type: entityData.type,
            description: entityData.description,
            mentionCount: 0,
          },
        })
      }

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æåŠè®°å½•
      const existingMention = await prisma.entityMention.findUnique({
        where: {
          entityId_noteId: {
            entityId: entity.id,
            noteId: note.id,
          },
        },
      })

      if (!existingMention) {
        // åˆ›å»ºæåŠè®°å½•
        await prisma.entityMention.create({
          data: {
            entityId: entity.id,
            noteId: note.id,
            context: this.extractContext(note.content, entityData.name),
            importance: note.importance,
          },
        })

        // æ›´æ–°å®ä½“ç»Ÿè®¡
        await prisma.entity.update({
          where: { id: entity.id },
          data: {
            mentionCount: { increment: 1 },
            firstMentionedAt: entity.mentionCount === 0 ? note.createdAt : undefined,
            lastMentionedAt: note.createdAt,
          },
        })
      }
    }
  }

  async buildEntityRelations(): Promise<void> {
    // è·å–æœ€è¿‘æåŠçš„å®ä½“å¯¹
    const mentions = await prisma.$queryRaw`
      SELECT
        e1.id as "fromEntityId",
        e2.id as "toEntityId",
        COUNT(*) as "strength"
      FROM "EntityMention" em1
      JOIN "EntityMention" em2 ON em1."noteId" = em2."noteId"
      JOIN "Entity" e1 ON em1."entityId" = e1.id
      JOIN "Entity" e2 ON em2."entityId" = e2.id
      WHERE e1.id != e2.id
      GROUP BY e1.id, e2.id
      HAVING COUNT(*) >= 2
      ORDER BY "strength" DESC
    ` as Array<{ fromEntityId: string; toEntityId: string; strength: number }>

    // åˆ›å»ºå…³ç³»
    for (const rel of mentions) {
      const existing = await prisma.entityRelation.findUnique({
        where: {
          fromEntityId_toEntityId_relationType: {
            fromEntityId: rel.fromEntityId,
            toEntityId: rel.toEntityId,
            relationType: 'related',
          },
        },
      })

      if (!existing) {
        await prisma.entityRelation.create({
          data: {
            fromEntityId: rel.fromEntityId,
            toEntityId: rel.toEntityId,
            relationType: 'related',
            strength: Math.min(rel.strength / 10, 1.0),
          },
        })
      }
    }
  }

  private extractContext(content: string, entityName: string): string {
    const index = content.indexOf(entityName)
    if (index === -1) return ''

    const start = Math.max(0, index - 50)
    const end = Math.min(content.length, index + entityName.length + 50)
    return content.slice(start, end).trim()
  }
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… åˆ›å»º/ç¼–è¾‘ç¬”è®°æ—¶è‡ªåŠ¨æå–å®ä½“
- âœ… å¯ä»¥æŸ¥çœ‹å®ä½“åˆ—è¡¨å’Œè¯¦æƒ…
- âœ… å¯ä»¥æŸ¥çœ‹å®ä½“çš„æåŠè®°å½•
- âœ… å¯ä»¥æŸ¥çœ‹å®ä½“å…³ç³»ç½‘ç»œ
- âœ… è‡ªåŠ¨ç”Ÿæˆç¬”è®°å…³è”å»ºè®®

---

### é˜¶æ®µ3ï¼šçŸ¥è¯†æç‚¼å’Œæ´å¯Ÿï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**ç›®æ ‡**ï¼šå¢å¼º AI æç¤ºè¯ï¼Œæå–æ›´æ·±å±‚æ¬¡çš„çŸ¥è¯†

**å®æ–½å†…å®¹**ï¼š

1. **æç¤ºè¯ä¼˜åŒ–**
   - æ›´æ–° `summary_analysis` æ¨¡æ¿ä¸ºå¢å¼ºç‰ˆ
   - æ·»åŠ  `analyze_note_deep` æ¨¡æ¿

2. **åç«¯å®ç°**
   - ä¿®æ”¹ `claude.service.ts` çš„ `generateSummaryAnalysis` æ–¹æ³•
   - æ·»åŠ  `analyzeNoteDeep` æ–¹æ³•

3. **å‰ç«¯å®ç°**
   - å¢å¼º `SummaryResultSheet.tsx`ï¼Œå±•ç¤ºçŸ¥è¯†æç‚¼éƒ¨åˆ†
   - åˆ›å»º `frontend/src/components/LearningsHighlight.tsx`

**æç¤ºè¯æ¨¡æ¿ç¤ºä¾‹**ï¼š

```typescript
{
  key: 'summary_analysis_enhanced',
  name: 'å¢å¼ºæ€»ç»“åˆ†æ',
  description: 'åˆ†æç¬”è®°å¹¶ç”Ÿæˆç»¼åˆæ€»ç»“ï¼ŒåŒ…å«çŸ¥è¯†æç‚¼',
  systemPart: `è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡æœ¬ï¼š
{
  "overview": "æ•´ä½“æ€»ç»“ï¼ˆ3-5å¥è¯ï¼‰",
  "keyAchievements": ["å…³é”®æˆå°±åˆ—è¡¨"],
  "pendingTasks": ["å¾…å®Œæˆä»»åŠ¡åˆ—è¡¨"],
  "insights": ["æ„Ÿæ‚Ÿæ´å¯Ÿåˆ—è¡¨"],
  "keyLearnings": ["å…³é”®å­¦ä¹ ç‚¹åˆ—è¡¨ï¼Œæ¯ä¸ª1-2å¥è¯ï¼Œè¯´æ˜å­¦åˆ°äº†ä»€ä¹ˆ"],
  "trends": ["è¶‹åŠ¿åˆ†æåˆ—è¡¨ï¼Œè¯†åˆ«æ•°æ®ä¸­çš„æ¨¡å¼æˆ–è¶‹åŠ¿"],
  "patterns": ["å‘ç°çš„æ¨¡å¼åˆ—è¡¨ï¼Œå¦‚è¡Œä¸ºæ¨¡å¼ã€æ€ç»´æ¨¡å¼ç­‰"],
  "recommendations": ["åŸºäºæ´å¯Ÿçš„å»ºè®®åˆ—è¡¨ï¼Œå¯æ‰§è¡Œçš„å»ºè®®"]
}`,
  userPart: `ä½ æ˜¯çŸ¥è¯†ç®¡ç†å’Œæ´å¯Ÿåˆ†æå¸ˆï¼Œè¯·æ·±åº¦åˆ†æä»¥ä¸‹æ—¶é—´èŒƒå›´å†…çš„ç¬”è®°ï¼Œæç‚¼æœ‰ä»·å€¼çš„çŸ¥è¯†ï¼š

æ—¶é—´èŒƒå›´ï¼š{timeRange}
ç¬”è®°æ€»æ•°ï¼š{noteCount}

æƒ…ç»ªåˆ†å¸ƒï¼š
{sentimentSummary}

ç¬”è®°å†…å®¹æ‘˜è¦ï¼š
{notesSummary}

é«˜é‡è¦æ€§ç¬”è®°ï¼š
{importantNotes}

åˆ†æè¦æ±‚ï¼š
1. overviewï¼šæ•´ä½“æ¦‚æ‹¬è¿™ä¸ªæ—¶é—´æ®µçš„ä¸»è¦æ´»åŠ¨å’Œå˜åŒ–
2. keyAchievementsï¼šæå–å·²å®Œæˆçš„é‡è¦äº‹é¡¹å’Œæˆå°±
3. pendingTasksï¼šè¯†åˆ«è¿˜æœªå®Œæˆçš„ä»»åŠ¡æˆ–å¾…åŠäº‹é¡¹
4. insightsï¼šåŸºäºç¬”è®°å†…å®¹æç‚¼æœ‰ä»·å€¼çš„æ„Ÿæ‚Ÿå’Œæ´å¯Ÿ
5. keyLearningsï¼š**é‡ç‚¹**ï¼Œæç‚¼å…³é”®å­¦ä¹ ç‚¹ï¼Œå›ç­”"å­¦åˆ°äº†ä»€ä¹ˆ"è¿™ä¸ªé—®é¢˜
6. trendsï¼šåˆ†ææ•°æ®è¶‹åŠ¿ï¼Œå¦‚æƒ…ç»ªå˜åŒ–ã€æ³¨æ„åŠ›è½¬ç§»ç­‰
7. patternsï¼šè¯†åˆ«è¡Œä¸ºæ¨¡å¼æˆ–æ€ç»´æ¨¡å¼
8. recommendationsï¼šåŸºäºä»¥ä¸Šåˆ†ææå‡ºå¯æ‰§è¡Œçš„å»ºè®®

çŸ¥è¯†æç‚¼åŸåˆ™ï¼š
- ä»å…·ä½“äº‹ä»¶ä¸­æç‚¼ä¸€èˆ¬æ€§çŸ¥è¯†
- è¯†åˆ«å¯å¤ç”¨çš„ç»éªŒå’Œæ–¹æ³•
- å‘ç°æ½œåœ¨è§„å¾‹å’Œå› æœå…³ç³»
- æç‚¼å¯è¿ç§»åˆ°å…¶ä»–åœºæ™¯çš„æ´å¯Ÿ`,
  variables: [
    { name: 'timeRange', description: 'æ—¶é—´èŒƒå›´', required: true, placeholder: '{timeRange}' },
    { name: 'noteCount', description: 'ç¬”è®°æ€»æ•°', required: true, placeholder: '{noteCount}' },
    { name: 'notesSummary', description: 'ç¬”è®°å†…å®¹æ‘˜è¦', required: true, placeholder: '{notesSummary}' },
    { name: 'sentimentSummary', description: 'æƒ…ç»ªåˆ†å¸ƒç»Ÿè®¡', required: false, placeholder: '{sentimentSummary}' },
    { name: 'importantNotes', description: 'é«˜é‡è¦æ€§ç¬”è®°', required: false, placeholder: '{importantNotes}' },
  ],
}
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ€»ç»“åŒ…å«å…³é”®å­¦ä¹ ç‚¹
- âœ… æ€»ç»“åŒ…å«è¶‹åŠ¿åˆ†æ
- âœ… æ€»ç»“åŒ…å«æ¨¡å¼è¯†åˆ«
- âœ… æ€»ç»“åŒ…å«å¯æ‰§è¡Œå»ºè®®
- âœ… å¯ä»¥æ·±åº¦åˆ†æå•æ¡ç¬”è®°

---

### é˜¶æ®µ4ï¼šçŸ¥è¯†ç½‘ç»œåŸºç¡€ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

**ç›®æ ‡**ï¼šæ„å»ºå¯è§†åŒ–çš„çŸ¥è¯†ç½‘ç»œ

**å®æ–½å†…å®¹**ï¼š

1. **å‰ç«¯å®ç°**
   - ä½¿ç”¨ D3.js æˆ– Cytoscape.js å®ç°çŸ¥è¯†ç½‘ç»œå¯è§†åŒ–
   - æ”¯æŒäº¤äº’å¼æ¢ç´¢ï¼ˆç‚¹å‡»èŠ‚ç‚¹ã€ç¼©æ”¾ã€è¿‡æ»¤ï¼‰

2. **åç«¯å®ç°**
   - ä¼˜åŒ–å®ä½“å…³ç³»æŸ¥è¯¢æ€§èƒ½
   - æ·»åŠ çŸ¥è¯†ç½‘ç»œæ•°æ®å¯¼å‡ºæ¥å£

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… å¯ä»¥å¯è§†åŒ–å±•ç¤ºå®ä½“å…³ç³»ç½‘ç»œ
- âœ… æ”¯æŒäº¤äº’å¼æ¢ç´¢
- âœ… å¯ä»¥æŒ‰å®ä½“ç±»å‹è¿‡æ»¤
- âœ… å¯ä»¥å¯¼å‡ºçŸ¥è¯†ç½‘ç»œæ•°æ®

---

## äº”ã€API è®¾è®¡

### 5.1 æ€»ç»“ç›¸å…³ API

```typescript
// è·å–æ€»ç»“å†å²åˆ—è¡¨
GET /api/summaries/history?mode=week&year=2024&month=1&limit=20

// è·å–å•ä¸ªæ€»ç»“è¯¦æƒ…
GET /api/summaries/:id

// å¯¹æ¯”ä¸¤ä¸ªæ€»ç»“
GET /api/summaries/:id/compare?compareId=<otherId>

// è·å–æ€»ç»“è¶‹åŠ¿åˆ†æ
GET /api/summaries/trends?mode=month&count=12

// æ‰‹åŠ¨ç¼–è¾‘æ€»ç»“
PUT /api/summaries/:id
```

### 5.2 å®ä½“ç›¸å…³ API

```typescript
// è·å–å®ä½“åˆ—è¡¨
GET /api/entities?type=technology&search=react&sort=mentionCount&order=desc&limit=50

// è·å–å®ä½“è¯¦æƒ…
GET /api/entities/:id

// è·å–å®ä½“çš„æ‰€æœ‰æåŠ
GET /api/entities/:id/mentions

// è·å–å®ä½“çš„å…³ç³»ç½‘ç»œ
GET /api/entities/:id/relations

// è·å–å®ä½“ç»Ÿè®¡
GET /api/entities/stats

// æ›´æ–°å®ä½“ä¿¡æ¯
PUT /api/entities/:id

// åˆ é™¤å®ä½“
DELETE /api/entities/:id
```

### 5.3 å…³è”ç›¸å…³ API

```typescript
// è·å–ç¬”è®°çš„å…³è”
GET /api/relations/:noteId

// è·å–å…³è”å»ºè®®
POST /api/relations/suggest
Body: { noteId: string, limit?: number }

// æ‰‹åŠ¨åˆ›å»ºå…³è”
POST /api/relations
Body: { fromId: string, toId: string, relationType?: string, reason?: string }

// åˆ é™¤å…³è”
DELETE /api/relations/:id
```

---

## å…­ã€å‰ç«¯ç•Œé¢è§„åˆ’

### 6.1 æ€»ç»“å†å²é¡µé¢ï¼ˆSummaryHistory.tsxï¼‰

**åŠŸèƒ½**ï¼š
- æŒ‰æ—¶é—´çº¿å±•ç¤ºæ‰€æœ‰å†å²æ€»ç»“
- æ”¯æŒæŒ‰æ¨¡å¼ï¼ˆæ—¥/å‘¨/æœˆ/å¹´ï¼‰ç­›é€‰
- æ”¯æŒæŒ‰å¹´ä»½/æœˆä»½ç­›é€‰
- ç‚¹å‡»æŸ¥çœ‹æ€»ç»“è¯¦æƒ…
- æ”¯æŒå¯¹æ¯”ä¸¤ä¸ªæ€»ç»“

**UI å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŸ¥è¯†æ€»ç»“å†å²                      [ç­›é€‰å™¨]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—¶é—´è½´è§†å›¾                                       â”‚
â”‚ 2024å¹´                                          â”‚
â”‚   1æœˆ                                           â”‚
â”‚   [01/15] 2024å¹´ç¬¬3å‘¨æ€»ç»“ (15æ¡ç¬”è®°)            â”‚
â”‚   [01/08] 2024å¹´ç¬¬2å‘¨æ€»ç»“ (23æ¡ç¬”è®°)            â”‚
â”‚   [01/01] 2024å¹´ç¬¬1å‘¨æ€»ç»“ (18æ¡ç¬”è®°)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å®ä½“ç®¡ç†é¡µé¢ï¼ˆEntityList.tsxï¼‰

**åŠŸèƒ½**ï¼š
- å±•ç¤ºæ‰€æœ‰å®ä½“åˆ—è¡¨
- æŒ‰ç±»å‹ç­›é€‰
- æŒ‰æåŠæ¬¡æ•°æ’åº
- æœç´¢å®ä½“
- ç‚¹å‡»æŸ¥çœ‹å®ä½“è¯¦æƒ…

**UI å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŸ¥è¯†å®ä½“åº“                    [æœç´¢] [ç­›é€‰]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»Ÿè®¡æ¦‚è§ˆ                                         â”‚
â”‚ æ€»å®ä½“æ•°: 234  äººå: 45  æŠ€æœ¯: 89  æ¦‚å¿µ: 100   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çƒ­é—¨å®ä½“                                         â”‚
â”‚ [React] æŠ€æœ¯  23æ¬¡æåŠ  æœ€å: 2024-01-15       â”‚
â”‚ [TypeScript] æŠ€æœ¯  18æ¬¡æåŠ  æœ€å: 2024-01-14  â”‚
â”‚ [å¼ ä¸‰] äººå  15æ¬¡æåŠ  æœ€å: 2024-01-13        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 çŸ¥è¯†ç½‘ç»œå¯è§†åŒ–ï¼ˆKnowledgeGraph.tsxï¼‰

**åŠŸèƒ½**ï¼š
- ä½¿ç”¨åŠ›å¯¼å‘å›¾å±•ç¤ºå®ä½“å…³ç³»
- æ”¯æŒç¼©æ”¾ã€æ‹–æ‹½
- ç‚¹å‡»èŠ‚ç‚¹æ˜¾ç¤ºè¯¦æƒ…
- æŒ‰ç±»å‹ç€è‰²

**UI å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŸ¥è¯†ç½‘ç»œå›¾è°±                    [ç­›é€‰] [å¯¼å‡º]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚              [React]                            â”‚
â”‚            /    |    \                          â”‚
â”‚      [TypeScript] [Next.js] [å‰ç«¯å¼€å‘]          â”‚
â”‚         /  |                                     â”‚
â”‚    [Prisma] [APIè®¾è®¡]                           â”‚
â”‚                                                 â”‚
â”‚ å›¾ä¾‹: ğŸ”´æŠ€æœ¯ ğŸ”µäººå ğŸŸ¢æ¦‚å¿µ ğŸŸ¡ç»„ç»‡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€å®æ–½æ—¶é—´çº¿

### ç¬¬1-2å‘¨ï¼šé˜¶æ®µ1 - æ•°æ®æŒä¹…åŒ–
- æ•°æ®æ¨¡å‹è®¾è®¡å’Œè¿ç§»
- åç«¯æœåŠ¡å®ç°
- åŸºç¡€å‰ç«¯ç•Œé¢

### ç¬¬3-4å‘¨ï¼šé˜¶æ®µ2 - å®ä½“è¯†åˆ«
- å®ä½“è¡¨ç»“æ„åˆ›å»º
- å®ä½“æå–æœåŠ¡
- å®ä½“ç®¡ç†ç•Œé¢

### ç¬¬5-6å‘¨ï¼šé˜¶æ®µ3 - çŸ¥è¯†æç‚¼
- æç¤ºè¯ä¼˜åŒ–
- å¢å¼ºæ€»ç»“ç”Ÿæˆ
- å‰ç«¯å±•ç¤ºä¼˜åŒ–

### ç¬¬7-8å‘¨ï¼šé˜¶æ®µ4 - çŸ¥è¯†ç½‘ç»œ
- å…³ç³»ç½‘ç»œæ„å»º
- å¯è§†åŒ–å®ç°
- ä¼˜åŒ–å’Œæµ‹è¯•

---

## å…«ã€å…³é”®æ–‡ä»¶æ¸…å•

å®æ–½æ­¤è®¡åˆ’éœ€è¦ä¿®æ”¹çš„å…³é”®æ–‡ä»¶ï¼š

- `backend/prisma/schema.prisma` - æ•°æ®æ¨¡å‹å®šä¹‰
- `backend/src/services/summary.service.ts` - æ€»ç»“æœåŠ¡
- `backend/src/services/claude.service.ts` - Claude API è°ƒç”¨
- `backend/src/services/prompt.service.ts` - æç¤ºè¯ç®¡ç†
- `shared/types/index.ts` - å…±äº«ç±»å‹å®šä¹‰
- `frontend/src/components/SummaryResultSheet.tsx` - æ€»ç»“ç»“æœå±•ç¤º

---

## ä¹ã€é£é™©è¯„ä¼°ä¸åº”å¯¹

### 9.1 é£é™©è¯†åˆ«

1. **Claude API é™åˆ¶**
   - Token é™åˆ¶å¯èƒ½å¯¼è‡´å¤§èŒƒå›´æ€»ç»“å¤±è´¥
   - é€Ÿç‡é™åˆ¶å¯èƒ½å½±å“å®æ—¶æ€§

2. **æ€§èƒ½é—®é¢˜**
   - å¤§é‡ç¬”è®°çš„å®ä½“è¯†åˆ«å¯èƒ½è€—æ—¶è¾ƒé•¿
   - çŸ¥è¯†ç½‘ç»œå¯è§†åŒ–å¯èƒ½å¡é¡¿

3. **æ•°æ®ä¸€è‡´æ€§**
   - ç¬”è®°æ›´æ–°åå®ä½“ä¿¡æ¯å¯èƒ½è¿‡æ—¶

### 9.2 åº”å¯¹ç­–ç•¥

1. **Claude API é™åˆ¶**
   - å®ç°æ™ºèƒ½åˆ†æ®µå¤„ç†
   - æ·»åŠ è¯·æ±‚é‡è¯•æœºåˆ¶
   - ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è°ƒç”¨

2. **æ€§èƒ½é—®é¢˜**
   - ä½¿ç”¨åå°ä»»åŠ¡å¤„ç†
   - å®ç°å¢é‡æ›´æ–°
   - æ·»åŠ è¿›åº¦åé¦ˆ

3. **æ•°æ®ä¸€è‡´æ€§**
   - å®šæœŸé‡æ–°æå–å®ä½“
   - å®ç°å®ä½“åˆå¹¶åŠŸèƒ½
   - æ·»åŠ æ•°æ®æ ¡éªŒ
