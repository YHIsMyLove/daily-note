// Prisma Schema - Daily Note

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 分类
model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?  // 颜色值，格式：HSL (如 "217 91% 60%") 或 HEX
  createdAt DateTime @default(now())

  // 关联到 Note
  notes Note[]

  @@index([name])
}

// 笔记块
model Note {
  id        String   @id @default(uuid())
  content   String
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // 软删除时间戳

  // LLM 处理结果
  // category 改为外键关联
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  summary    String?
  sentiment  String? // 'positive' | 'neutral' | 'negative'
  importance Int     @default(5)
  metadata   String? // JSON string

  // 每日待办笔记相关字段
  isDailyTodoNote  Boolean   @default(false)  // 标记为每日待办笔记
  dailyTodoDate    DateTime?                   // 每日待办笔记的日期（用于查询）

  // 关联关系
  relations    NoteRelation[] @relation("FromNote")
  relatedFrom  NoteRelation[] @relation("ToNote")
  noteTags     NoteTag[]
  claudeTasks  ClaudeTask[]

  @@index([date])
  @@index([categoryId])
  @@index([deletedAt])
  @@index([isDailyTodoNote, dailyTodoDate])
}

// 标签
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?  // 颜色值，格式：HSL (如 "217 91% 60%") 或 HEX
  createdAt DateTime @default(now())

  // 关联到 NoteTag
  noteTags NoteTag[]

  @@index([name])
}

// 笔记-标签关联表（多对多）
model NoteTag {
  id        String   @id @default(uuid())
  noteId    String
  tagId     String
  createdAt DateTime @default(now())

  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([noteId, tagId])
  @@index([noteId])
  @@index([tagId])
}

// 笔记关联（笔记之间的关联关系）
model NoteRelation {
  id         String   @id @default(uuid())
  fromId     String
  toId       String
  similarity Float?
  reason     String?
  createdAt  DateTime @default(now())

  from Note @relation("FromNote", fields: [fromId], references: [id], onDelete: Cascade)
  to   Note @relation("ToNote", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
}

// Claude 任务队列
model ClaudeTask {
  id          String   @id @default(uuid())
  type        String   // 'classify_note', 'analyze_trends', 'extract_todo_tasks', 'auto_complete_todo', etc.
  noteId      String?  // 关联笔记ID（如适用）
  payload     String   // JSON 格式任务数据
  status      String   @default("PENDING") // 'PENDING' | 'NEEDS_REVIEW' | 'RUNNING' | 'COMPLETED' | 'FAILED' | 'CANCELLED'
  priority    Int      @default(0)
  error       String?
  result      String?  // JSON 格式结果
  startedAt   DateTime?
  completedAt DateTime? // 任务队列处理完成时间（区别于 Todo 的完成时间）
  retryCount  Int      @default(0)
  lastRetryAt DateTime?
  nextRetryAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  note Note? @relation(fields: [noteId], references: [id], onDelete: SetNull)

  // Todo 特定字段（当 type 为 todo 相关时使用）
  title                  String?  // Todo 标题
  description            String?  // Todo 描述
  dueDate                DateTime? // Todo 截止日期
  todoCompletedAt        DateTime? // Todo 完成时间（用户完成或 AI 自动完成）
  isAiGenerated          Boolean  @default(false) // 是否由 AI 提取的 Todo
  autoCompletionEnabled  Boolean  @default(false) // 是否启用 AI 自动完成
  autoCompletionTaskId   String?  // 自动完成任务的 ClaudeTask ID（指向另一个 ClaudeTask）
  autoCompletionError    String?  // 自动完成失败时的错误信息
  todoMetadata           String?  // JSON：Todo 元数据（estimatedTime, complexity, tags）

  // 嵌套结构支持（最多3级：根任务 -> 子任务 -> 孙任务）
  parentId    String?           // 父任务 ID
  level       Int      @default(0)  // 层级：0=根任务, 1=子任务, 2=孙任务
  parent      ClaudeTask?       @relation("TodoHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    ClaudeTask[]      @relation("TodoHierarchy")

  @@index([status])
  @@index([noteId])
  @@index([type])
  @@index([isAiGenerated])
  @@index([autoCompletionEnabled])
  @@index([dueDate])
  @@index([parentId])
  @@index([level])
}

// 提示词模板
model PromptTemplate {
  id          String   @id @default(uuid())
  key         String   @unique           // 唯一标识，如 'classify_note'
  name        String                      // 显示名称
  description String?                     // 描述
  systemPart  String                      // 限定区（不可修改）
  userPart    String                      // 提示词区（用户可修改）
  variables   String                      // JSON 数组，变量定义
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)    // 是否为系统默认
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([isActive])
}

// 总结记录（持久化存储）
model Summary {
  id          String   @id @default(uuid())
  mode        String   // 'day' | 'week' | 'month' | 'year' | 'custom'

  // 周期唯一标识，用于去重
  periodKey   String   // day: "2024-01-15", week: "2024-W03", month: "2024-01", year: "2024"

  startDate   DateTime
  endDate     DateTime

  // 总结内容
  overview    String   // AI 生成的概述
  achievements String   // JSON 数组：关键成就
  pendingTasks String   // JSON 数组：待办任务
  insights    String   // JSON 数组：感悟洞察

  // 知识提炼（新增）
  keyLearnings String?  // JSON 数组：关键学习点
  trends      String?   // JSON 数组：趋势分析
  patterns    String?   // JSON 数组：发现的模式
  recommendations String? // JSON 数组：基于洞察的建议

  // 统计数据（结构化存储）
  noteCount   Int
  sentimentData String  // JSON：心情曲线数据
  categoryStats String  // JSON：分类统计
  tagStats    String   // JSON：标签统计
  importanceStats String // JSON：重要性统计
  taskStats   String   // JSON：任务完成统计
  timeStats   String   // JSON：时间分布统计
  todoStats   String   @default("{}") // JSON：待办完成统计

  // 元数据
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  taskId      String?  // 关联的 ClaudeTask ID（改为可选）
  isAutoGenerated Boolean @default(true)

  // 唯一约束：同一模式 + 同一周期只有一条记录
  @@unique([mode, periodKey])
  @@index([startDate])
  @@index([generatedAt])
}

// ===== 工作流配置相关模型 =====

// 工作流配置（定义触发场景）
model WorkflowConfig {
  id          String   @id @default(uuid())
  trigger     String   @unique  // note_created, note_updated, note_deleted, manual_analysis
  label       String            // 显示名称
  description String?           // 描述
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  steps       WorkflowStep[]
  connections WorkflowConnection[]

  @@index([trigger])
  @@index([enabled])
}

// 工作流步骤（定义具体任务节点）
model WorkflowStep {
  id              String   @id @default(uuid())
  workflowId      String
  workflow        WorkflowConfig @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  taskType        String            // classify_note, extract_todo_tasks, analyze_relations, etc.
  label           String            // 显示名称
  enabled         Boolean   @default(true)
  priority        Int               // 执行优先级
  position        Int               // 在流程中的顺序位置
  dependencies    String?           // 依赖的任务ID列表 (JSON数组)
  config          String?           // 任务特定配置 (JSON)
  nodeX           Int       @default(0)  // 节点在流程图中的 X 坐标
  nodeY           Int       @default(0)  // 节点在流程图中的 Y 坐标
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 作为源节点的连线
  fromConnections WorkflowConnection[] @relation("FromStep")
  // 作为目标节点的连线
  toConnections   WorkflowConnection[] @relation("ToStep")

  @@index([workflowId])
  @@index([taskType])
  @@index([position])
}

// 工作流连线（定义节点之间的连接关系）
model WorkflowConnection {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    WorkflowConfig @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  fromStepId  String   // 源节点ID
  toStepId    String   // 目标节点ID
  fromStep    WorkflowStep @relation("FromStep", fields: [fromStepId], references: [id], onDelete: Cascade)
  toStep      WorkflowStep @relation("ToStep", fields: [toStepId], references: [id], onDelete: Cascade)
  condition   String?  // 连接条件表达式
  createdAt   DateTime @default(now())

  @@unique([workflowId, fromStepId, toStepId])
  @@index([workflowId])
  @@index([fromStepId])
  @@index([toStepId])
}

// ===== Pipeline 模型（提示词管道） =====

// Pipeline 配置（提示词管道）
model Pipeline {
  id          String   @id @default(uuid())
  name        String   @unique  // Pipeline 名称
  description String?            // 描述
  trigger     String   @default("manual")  // 触发方式: manual, note_created, note_updated, etc.
  enabled     Boolean  @default(true)
  nodes       PipelineNode[]
  edges       PipelineEdge[]
  executions  PipelineExecution[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([trigger])
  @@index([enabled])
}

// Pipeline 节点（提示词节点）
model PipelineNode {
  id              String   @id @default(uuid())
  pipelineId      String
  pipeline        Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  // 核心配置：节点引用提示词模板
  promptKey       String   // 引用 PromptTemplate.key
  promptName      String   // 冗余存储，用于快速显示

  // 执行配置
  enabled         Boolean  @default(true)
  config          String?  // JSON：节点特定配置（温度、模型、最大 Token 等）

  // 坐标（前端可视化）
  nodeX           Int      @default(0)
  nodeY           Int      @default(0)

  // 关联
  incomingEdges   PipelineEdge[] @relation("IncomingEdge")
  outgoingEdges   PipelineEdge[] @relation("OutgoingEdge")
  executions      PipelineNodeExecution[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pipelineId])
  @@index([promptKey])
}

// Pipeline 连线（数据流向）
model PipelineEdge {
  id          String   @id @default(uuid())
  pipelineId  String
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  fromNodeId  String
  toNodeId    String
  fromNode    PipelineNode @relation("OutgoingEdge", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode      PipelineNode @relation("IncomingEdge", fields: [toNodeId], references: [id], onDelete: Cascade)

  // 数据流转配置
  outputKey   String   @default("output")  // 源节点输出键
  inputKey    String   @default("input")   // 目标节点输入键
  condition   String?  // 条件表达式（可选）

  createdAt   DateTime @default(now())

  @@unique([pipelineId, fromNodeId, toNodeId])
  @@index([pipelineId])
  @@index([fromNodeId])
  @@index([toNodeId])
}

// Pipeline 执行记录
model PipelineExecution {
  id              String   @id @default(uuid())
  pipelineId      String
  pipeline        Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  triggerEvent    String              // 触发事件
  status          String   @default("pending")  // pending, running, completed, failed, cancelled
  inputData       String?             // JSON：输入数据
  outputData      String?             // JSON：输出数据
  error           String?             // 错误信息

  nodeExecutions  PipelineNodeExecution[]

  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([pipelineId])
  @@index([status])
  @@index([createdAt])
}

// Pipeline 节点执行记录
model PipelineNodeExecution {
  id              String   @id @default(uuid())
  executionId     String
  execution       PipelineExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  nodeId          String
  node            PipelineNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  status          String   @default("pending")  // pending, running, completed, failed, skipped
  inputData       String?             // JSON：节点输入
  outputData      String?             // JSON：节点输出
  error           String?             // 错误信息

  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([executionId])
  @@index([nodeId])
  @@index([status])
}
