// Prisma Schema - Daily Note

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 分类
model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?  // 颜色值，格式：HSL (如 "217 91% 60%") 或 HEX
  createdAt DateTime @default(now())

  // 关联到 Note
  notes Note[]

  @@index([name])
}

// 笔记块
model Note {
  id        String   @id @default(uuid())
  content   String
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // 软删除时间戳

  // LLM 处理结果
  // category 改为外键关联
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  summary    String?
  sentiment  String? // 'positive' | 'neutral' | 'negative'
  importance Int     @default(5)
  metadata   String? // JSON string

  // 每日待办笔记相关字段
  isDailyTodoNote  Boolean   @default(false)  // 标记为每日待办笔记
  dailyTodoDate    DateTime?                   // 每日待办笔记的日期（用于查询）

  // 关联关系
  relations    NoteRelation[] @relation("FromNote")
  relatedFrom  NoteRelation[] @relation("ToNote")
  noteTags     NoteTag[]
  claudeTasks  ClaudeTask[]

  @@index([date])
  @@index([categoryId])
  @@index([deletedAt])
  @@index([isDailyTodoNote, dailyTodoDate])
}

// 标签
model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String?  // 颜色值，格式：HSL (如 "217 91% 60%") 或 HEX
  createdAt DateTime @default(now())

  // 关联到 NoteTag
  noteTags NoteTag[]

  @@index([name])
}

// 笔记-标签关联表（多对多）
model NoteTag {
  id        String   @id @default(uuid())
  noteId    String
  tagId     String
  createdAt DateTime @default(now())

  note Note @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([noteId, tagId])
  @@index([noteId])
  @@index([tagId])
}

// 笔记关联（笔记之间的关联关系）
model NoteRelation {
  id         String   @id @default(uuid())
  fromId     String
  toId       String
  similarity Float?
  reason     String?
  createdAt  DateTime @default(now())

  from Note @relation("FromNote", fields: [fromId], references: [id], onDelete: Cascade)
  to   Note @relation("ToNote", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
}

// Claude 任务队列
model ClaudeTask {
  id          String   @id @default(uuid())
  type        String   // 'classify_note', 'analyze_trends', 'extract_todo_tasks', 'auto_complete_todo', etc.
  noteId      String?  // 关联笔记ID（如适用）
  payload     String   // JSON 格式任务数据
  status      String   @default("PENDING") // 'PENDING' | 'NEEDS_REVIEW' | 'RUNNING' | 'COMPLETED' | 'FAILED' | 'CANCELLED'
  priority    Int      @default(0)
  error       String?
  result      String?  // JSON 格式结果
  startedAt   DateTime?
  completedAt DateTime? // 任务队列处理完成时间（区别于 Todo 的完成时间）
  retryCount  Int      @default(0)
  lastRetryAt DateTime?
  nextRetryAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  note Note? @relation(fields: [noteId], references: [id], onDelete: SetNull)

  // Todo 特定字段（当 type 为 todo 相关时使用）
  title                  String?  // Todo 标题
  description            String?  // Todo 描述
  dueDate                DateTime? // Todo 截止日期
  todoCompletedAt        DateTime? // Todo 完成时间（用户完成或 AI 自动完成）
  isAiGenerated          Boolean  @default(false) // 是否由 AI 提取的 Todo
  autoCompletionEnabled  Boolean  @default(false) // 是否启用 AI 自动完成
  autoCompletionTaskId   String?  // 自动完成任务的 ClaudeTask ID（指向另一个 ClaudeTask）
  autoCompletionError    String?  // 自动完成失败时的错误信息
  todoMetadata           String?  // JSON：Todo 元数据（estimatedTime, complexity, tags）

  // 嵌套结构支持（最多3级：根任务 -> 子任务 -> 孙任务）
  parentId    String?           // 父任务 ID
  level       Int      @default(0)  // 层级：0=根任务, 1=子任务, 2=孙任务
  parent      ClaudeTask?       @relation("TodoHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    ClaudeTask[]      @relation("TodoHierarchy")

  @@index([status])
  @@index([noteId])
  @@index([type])
  @@index([isAiGenerated])
  @@index([autoCompletionEnabled])
  @@index([dueDate])
  @@index([parentId])
  @@index([level])
}

// 提示词模板
model PromptTemplate {
  id          String   @id @default(uuid())
  key         String   @unique           // 唯一标识，如 'classify_note'
  name        String                      // 显示名称
  description String?                     // 描述
  systemPart  String                      // 限定区（不可修改）
  userPart    String                      // 提示词区（用户可修改）
  variables   String                      // JSON 数组，变量定义
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)    // 是否为系统默认
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@index([isActive])
}

// 总结记录（持久化存储）
model Summary {
  id          String   @id @default(uuid())
  mode        String   // 'day' | 'week' | 'month' | 'year' | 'custom'

  // 周期唯一标识，用于去重
  periodKey   String   // day: "2024-01-15", week: "2024-W03", month: "2024-01", year: "2024"

  startDate   DateTime
  endDate     DateTime

  // 总结内容
  overview    String   // AI 生成的概述
  achievements String   // JSON 数组：关键成就
  pendingTasks String   // JSON 数组：待办任务
  insights    String   // JSON 数组：感悟洞察

  // 知识提炼（新增）
  keyLearnings String?  // JSON 数组：关键学习点
  trends      String?   // JSON 数组：趋势分析
  patterns    String?   // JSON 数组：发现的模式
  recommendations String? // JSON 数组：基于洞察的建议

  // 统计数据（结构化存储）
  noteCount   Int
  sentimentData String  // JSON：心情曲线数据
  categoryStats String  // JSON：分类统计
  tagStats    String   // JSON：标签统计
  importanceStats String // JSON：重要性统计
  taskStats   String   // JSON：任务完成统计
  timeStats   String   // JSON：时间分布统计
  todoStats   String   @default("{}") // JSON：待办完成统计

  // 元数据
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  taskId      String?  // 关联的 ClaudeTask ID（改为可选）
  isAutoGenerated Boolean @default(true)

  // 唯一约束：同一模式 + 同一周期只有一条记录
  @@unique([mode, periodKey])
  @@index([startDate])
  @@index([generatedAt])
}
